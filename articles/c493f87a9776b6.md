---
title: "goã®ã‚³ãƒ¼ãƒ‰ã‚’CI/CDã™ã‚‹"
emoji: "ğŸ•µï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go", "CICD", "koyeb"]
published: true
---

# ã¾ãš

ã“ã¡ã‚‰ã®è¨˜äº‹ã¯ç§ãŒè¶³ã‚Šã¦ã„ãªã„ã¨æ€ã†æ‰€ã‚’é‡ç‚¹çš„ã«å‹‰å¼·ã™ã‚‹ã€‚
onion7 æ—¥é–“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã® Day4 ã«ãªã‚Šã¾ã™ã€‚
è©³ã—ãã¯[ã“ã“](https://zenn.dev/onion0904/articles/ff700890522030)ã®å†’é ­ã§æ›¸ã„ã¦ã‚ã‚‹ã®ã§æ°—ã«ãªã‚‹äººã¯è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚

# Day4

Day4 ã§ã¯ä»¥å‰ä½œã£ãŸ API ã® CI/CD ã‚’ githubactions ã§ä½œæˆã—ã¦ã¿ã¾ã—ãŸã€‚
@[card](https://github.com/onion0904/carshare-backend)

# CI ã¨ã¯

CI(ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)ã¨ã¯è‡ªå‹•ã§ test ã‚„ lint ã‚’ã™ã‚‹ã“ã¨ã§ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’æ‹…ä¿ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

> circleci ã„ã‚ããƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’ç¢ºä¿ã—ãªãŒã‚‰ã€é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å‘ä¸Šã•ã›ã‚‹ DevOpsï¼ˆãƒ‡ãƒ–ã‚ªãƒ—ã‚¹ï¼‰ ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºæ‰‹æ³•ã‚‰ã—ã„ã§ã™ã€‚

# CD ã¨ã¯

CD(ç¶™ç¶šçš„ãƒ‡ãƒªãƒãƒªãƒ¼)ã¨ã¯å¤‰æ›´ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã‚‚ã®ã§ã™ã€‚
CD ã§ã¯åŸºæœ¬çš„ã« CI ã«ã‚ˆã£ã¦å“è³ªãŒæ‹…ä¿ã•ã‚ŒãŸã‚‚ã®ã‚’ãƒ“ãƒ«ãƒ‰ã€ãƒ†ã‚¹ãƒˆã€ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã™ã€‚

# ä»Šå›ã®æ¦‚è¦

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€CI ã§ test ã¨ lint ã¨è„†å¼±æ€§ã®æ¤œå‡ºã‚’è¡Œã„ã¾ã—ãŸã€‚Koyeb ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚‹ã®ã§ã™ãŒã€Koyeb è‡ªä½“ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã—ã‹ã—ã€CI ã‚’ã—ãŸãªã‚‰ CD ã‚‚æ›¸ããŸã„ã¨ã„ã†ã“ã¨ã§æ›¸ãã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/6c7eb2ff1d54-20250619.png =400x)

# ä»Šå›ã® CI

ä»Šå›ã® CI ã§ã¯
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç”¨ã„ã¦ test ã¨ lint ã¨è„†å¼±æ€§ã®æ¤œå‡ºã‚’è¡Œã„ã¾ã—ãŸã€‚
| ç¨®é¡ | ã‚³ãƒãƒ³ãƒ‰ |
|------------|-------------------|
| test | go test |
| lint | golangci-lint+(goimports+gofmt) |
| è„†å¼±æ€§ã®æ¤œå‡º | govulncheck |

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åŸºæœ¬ã®æ›¸ãæ–¹

GithubActions ã§ã¯ root ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«.github/workflows ã®ä¸‹ã«æŒ‡å®šã•ã‚ŒãŸæ›¸ãæ–¹ã§.yml ã‚„.toml ãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãã“ã¨ã§æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã—ã¾ã™ã€‚

### å…·ä½“çš„ã«ã¯

åŸºæœ¬çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¾ã™

```yml:ci.yml
name: CI #ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰

on:
  push: #ä¸‹ã®ãƒ–ãƒ©ãƒ³ãƒãŒpushã•ã‚ŒãŸã¨ãã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
    branches: ["*", "!main"]
  pull_request: #ä¸‹ã®ãƒ–ãƒ©ãƒ³ãƒã«å‘ã‘ã¦ãƒ—ãƒ«ãƒªã‚¯ãŒä½œã‚‰ã‚ŒãŸã¨ãã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
    branches: [main]

jobs: #ã“ã®ä¸‹ã«ãã‚Œãã‚Œã®å‡¦ç†ã‚’æ›¸ã„ã¦ã„ã
```

ã¾ãŸã€ä»–äººã«çŸ¥ã‚‰ã‚Œã¦ã¯ã„ã‘ãªã„ç’°å¢ƒå¤‰æ•°ã¯
ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚
```
${{ github.PASSWORD }}
```
ä¸­èº«ã¯githubã®ãƒªãƒã‚¸ãƒˆãƒªã®settings->Environments->New environment->Add environment secretã§è¨­å®šã§ãã¾ã™ã€‚

## test
test ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚

:::details testã®ymlãƒ•ã‚¡ã‚¤ãƒ«
```yml:ci.yml
  test:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Goã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
        run: go mod tidy

      - name: ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: go test ./...
```
:::

## lint
lintã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚

:::details lintã®ymlãƒ•ã‚¡ã‚¤ãƒ«
```yml:ci.yml
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Goã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: golangci-lintã‚’å®Ÿè¡Œ
        uses: golangci/golangci-lint-action@v6
```
:::

ã“ã“ã‚‚teståŒæ§˜ã«è‡ªæ˜ã§ã™ãŒã€golangci-lintã—ã‹æ›¸ã„ã¦ã„ãªã„ã®ã«ç–‘å•ã‚’æŒã¡ã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿãã†ã§ã™**goimports,gofmt**ã‚’æ›¸ã„ã¦ã„ã¾ã›ã‚“ã€‚
å®Ÿã¯golangci-lintã«**goimports,gofmt**ã‚’å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã™ã€‚

### golangci-lintã«goimports,gofmtã‚’å…¥ã‚Œã‚‹
rootãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«.golangci.ymlã‚’ä½œæˆã—ã¦æ›¸ãè¾¼ã‚€ã“ã¨ã§ã€golangci-lintã®å‡¦ç†ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
**å…·ä½“çš„ã«ã¯**
golangci-lintã ã‘ã§ã¯æ¤œå‡ºã§ãã¦ã„ãªã„ã‚‚ã®ã‚’å¢—ã‚„ã—ãŸã‚Šã€golangci-lintã§éå‰°ã«æ¤œå‡ºã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚‚ã®ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚
```yml:.golangci.yml
linters:
  enable:
    - goimports
    - gofmt
```

## è„†å¼±æ€§ã®æ¤œå‡º
ã“ã“ã§ã¯è„†å¼±æ€§(versionã®æ›´æ–°ãŒã•ã‚Œã¦ã„ãªã„ãªã©)ã‚’æ¤œå‡ºã—ã¾ã™ã€‚
ã“ã‚Œã¯å¤–éƒ¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã®ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

:::details vulncheckã®ymlãƒ•ã‚¡ã‚¤ãƒ«
```yml:ci.yml
  vulncheck:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Goã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v5
        with: 
          go-version-file: go.mod
          
      - name: govulncheck ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: govulncheck ã‚’å®Ÿè¡Œ
        run: govulncheck ./...
```
:::

# ä»Šå›ã®CD
ä»Šå›ã¯koyebã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒ•ãƒ­ãƒ¼ã ã‘æ›¸ã„ã¦ã„ã¾ã™ã€‚
CDã‚‚åŸºæœ¬çš„ã«CIã¨åŒã˜ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

:::details CDã®ymlãƒ•ã‚¡ã‚¤ãƒ«
```yml:deploy.yml
name: deploy

on:
  push:
    branches: [main] #ä»–ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰push(ãƒãƒ¼ã‚¸)ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚


jobs:
  deploy-koyeb:
    runs-on: ubuntu-latest
    environment: carshare-backend
    concurrency:
      group: koyeb-${{ github.ref_name }}
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Install Koyeb CLI # Koyeb CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: koyeb-community/koyeb-actions@v2
        with:
          api_token: ${{ secrets.KOYEB_API_TOKEN }}

      - name: Deploy to Koyeb # Koyebã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: koyeb/action-git-deploy@v1
        with:
          app-name: my-go-api           # Koyeb ä¸Šã® App å
          service-name: api-service     # Service å
          git-branch: ${{ github.ref_name }}
          git-builder: docker
          git-docker-dockerfile: Dockerfile
          privileged: true
          service-instance-type: free
          service-regions: was
          service-min-instances: 0
          service-ports: "8080:http"    # Koyeb å´ã®ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°
          service-routes: "/:8080"      # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
```
:::

ã¾ãšã€koyebã®CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ã‚’æ•´ãˆã¾ã™ã€‚
æ¬¡ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã—ã¾ã™ã€‚koyebã¯dockerfileã‚’æ¸¡ã™ã“ã¨ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚
ãã—ã¦ã€æœ€å¾Œã«å‹•ã‹ã—ãŸã¨ãã®ãƒãƒ¼ãƒˆãªã©ã®è©³ç´°ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§å®Œäº†ã§ã™ã€‚


# æ„Ÿæƒ³
ä»Šå›ã®CI/CDã‚’é€šã—ã¦ã©ã‚“ãªäººã§ã‚‚ã‚¿ã‚¹ã‚¯ã‚’ä»»ã›ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã‚‚ã—ã€é–‹ç™ºåˆå¿ƒè€…ã§ã‚‚CIãŒé€šã£ã¦ãªã„ã‹ã‚‰ã€ã“ã®æ›¸ãæ–¹ç›´ã—ã¦ã¨è¨€ãˆã¾ã™ã­ï¼
ãã—ã¦ã€è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚‚æ›¸ãç›´ã™ã“ã¨ã«ã‚‚ãªã‚Šã¾ã—ãŸ...
çš†ã•ã‚“ã‚‚ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¯æ„è­˜ã—ã¦æ›¸ãã¾ã—ã‚‡ã†ã­ï¼

# Day3â†“
@[card](https://zenn.dev/onion0904/articles/1c441df9070736)

# å‚è€ƒè³‡æ–™
[workflowã«ã¤ã„ã¦](https://docs.github.com/ja/actions/writing-workflows/about-workflows)
[ymlã®æ§‹æ–‡](https://docs.github.com/ja/actions/writing-workflows/workflow-syntax-for-github-actions#about-yaml-syntax-for-workflows)
[GitHub Actionsã‚’ç”¨ã„ãŸCI/CDã®åŸºç¤](https://qiita.com/ebasuke0226/items/a775e60a31535d91c770)
[goã§ã®CI/CD](https://qiita.com/urabexon/items/dbdb70a6032bfaf2de20)
[goã®CIã«å½¹ç«‹ã¤ãƒ„ãƒ¼ãƒ«](https://note.com/navitime_tech/n/na66c2574face)